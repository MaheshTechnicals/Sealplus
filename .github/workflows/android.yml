name: Build Release APK

on:
  workflow_dispatch:

jobs:

  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3.2.1

    - uses: gradle/actions/setup-gradle@v4
      with:
        build-scan-publish: true
        build-scan-terms-of-use-url: "https://gradle.com/help/legal-terms-of-use"
        build-scan-terms-of-use-agree: "yes"

    - run: gradle assembleRelease

    - name: Sign app APK
      id: sign_app
      continue-on-error: true
      uses: ilharp/sign-android-release@nightly
      env:
        ANDROID_SIGNING_KEY: ${{ secrets.ANDROID_SIGNING_KEY }}
      with:
        releaseDir: app/build/outputs/apk
        signingKey: ${{ secrets.ANDROID_SIGNING_KEY }}
        keyAlias: ${{ secrets.ANDROID_ALIAS }}
        keyStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        keyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}

    - name: Get version name
      id: version
      run: |
        VERSION=$(grep -A 1 'val currentVersion: Version =' buildSrc/src/main/kotlin/Version.kt | grep -oP 'versionMajor = \K\d+' | head -1).$(grep -A 1 'val currentVersion: Version =' buildSrc/src/main/kotlin/Version.kt | grep -oP 'versionMinor = \K\d+' | head -1).$(grep -A 1 'val currentVersion: Version =' buildSrc/src/main/kotlin/Version.kt | grep -oP 'versionPatch = \K\d+' | head -1)
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"

    - name: Clean up temp and unsigned APKs
      run: |
        rm -f app/build/outputs/apk/generic/release/*-temp.apk
        find app/build/outputs/apk/generic/release/ -name "*.apk" ! -name "*-signed.apk" -delete
        echo "Remaining APKs:"
        ls -lh app/build/outputs/apk/generic/release/*.apk

    - name: Read release configuration
      id: release_config
      run: |
        SHOULD_RELEASE=$(jq -r '.release' release.json)
        echo "SHOULD_RELEASE=${SHOULD_RELEASE}" >> $GITHUB_OUTPUT
        echo "Release flag: ${SHOULD_RELEASE}"
        if [ "${SHOULD_RELEASE}" = "true" ]; then
          echo "‚úÖ Release will be published"
        else
          echo "‚ö†Ô∏è Release publishing is disabled - APKs will be uploaded as artifacts only"
        fi

    - name: Create Release
      if: steps.release_config.outputs.SHOULD_RELEASE == 'true'
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}
        name: Seal Plus v${{ steps.version.outputs.VERSION }}
        body: |
          ## üöÄ Seal Plus v1.2.4 - App Lock & Enhanced Security
          
          ### üîí App Lock System (Security & Privacy)
          
          * **Multi-Factor Authentication**
            * **4-digit PIN protection** - Fast and secure PIN authentication
            * **Biometric authentication** - Unlock with fingerprint or face recognition
            * **Old PIN verification** - Secure PIN change requires current PIN
            * **Complete reset option** - Reset all AppLock settings if needed
          
          * **Smart Timeout Management**
            * **Immediately** - Always require authentication when app opens
            * **Flexible timeouts** - 1, 2, 5, 10, 15, 30, or 60 minutes of inactivity
            * **Background protection** - Auto-lock when app goes to background
            * **Persistent settings** - Timeout settings survive app restarts
          
          * **Secure Implementation**
            * **SHA-256 PIN hashing** - PIN never stored in plain text
            * **MMKV encrypted storage** - All data securely stored locally
            * **Brute force protection** - Maximum 5 attempts with auto-dismiss
            * **No cloud sync** - All data stays on your device
          
          ### üé® UI/UX Enhancements
          
          * **Exit Confirmation Dialog**
            * Prevents accidental app closure from Download Queue page
            * Stylish Material Design 3 styled dialog
            * Theme-aware colors matching all themes including Gradient Dark
            * Clear messaging about ongoing downloads
            * Smooth animations with proper haptic feedback
          
          * **Animated Lock Screen**
            * Beautiful number pad with smooth transitions
            * PIN dots indicator with visual feedback
            * Error shake animations on incorrect PIN
            * Haptic feedback for better user experience
          
          ---
          
          ### üì¶ Installation
          Download the appropriate APK for your device:
          - **Universal APK**: Works on all devices (recommended)
          - **arm64-v8a**: For 64-bit ARM devices (most modern phones)
          - **armeabi-v7a**: For 32-bit ARM devices
          - **x86_64**: For 64-bit x86 devices
          - **x86**: For 32-bit x86 devices
          
          ### üíé Key Features
          - üîí App Lock with PIN & Biometric authentication
          - üö™ Exit confirmation dialog for Download Queue
          - üåê Network type restrictions (WiFi/Mobile/Any)
          - üîî Smart customizable notifications
          - üé® Gradient Dark theme with glassmorphism
          - üîÑ Auto-update system enabled by default
          - üì• Download from 1000+ sites via yt-dlp
          - üé® Material Design 3 with premium UI
          - üåç 50+ language translations
          - ‚öôÔ∏è Custom command templates
          - üìä Format selection and quality options
          
          ### üìù Full Changelog
          See [CHANGELOG.md](https://github.com/MaheshTechnicals/Sealplus/blob/main/CHANGELOG.md) for complete version history.
          
          ---
          
          Built on: ${{ github.event.head_commit.timestamp }}
          Commit: ${{ github.sha }}
        draft: false
        prerelease: false
        make_latest: true
        files: |
          app/build/outputs/apk/generic/release/*-signed.apk

    - name: Upload Universal APK as Artifact
      if: steps.release_config.outputs.SHOULD_RELEASE == 'false'
      uses: actions/upload-artifact@v4
      with:
        name: SealPlus-${{ steps.version.outputs.VERSION }}-universal
        path: app/build/outputs/apk/generic/release/*-universal-signed.apk
        if-no-files-found: warn
        retention-days: 30

    - name: Upload arm64-v8a APK as Artifact
      if: steps.release_config.outputs.SHOULD_RELEASE == 'false'
      uses: actions/upload-artifact@v4
      with:
        name: SealPlus-${{ steps.version.outputs.VERSION }}-arm64-v8a
        path: app/build/outputs/apk/generic/release/*-arm64-v8a-signed.apk
        if-no-files-found: warn
        retention-days: 30

    - name: Upload armeabi-v7a APK as Artifact
      if: steps.release_config.outputs.SHOULD_RELEASE == 'false'
      uses: actions/upload-artifact@v4
      with:
        name: SealPlus-${{ steps.version.outputs.VERSION }}-armeabi-v7a
        path: app/build/outputs/apk/generic/release/*-armeabi-v7a-signed.apk
        if-no-files-found: warn
        retention-days: 30

    - name: Upload x86_64 APK as Artifact
      if: steps.release_config.outputs.SHOULD_RELEASE == 'false'
      uses: actions/upload-artifact@v4
      with:
        name: SealPlus-${{ steps.version.outputs.VERSION }}-x86_64
        path: app/build/outputs/apk/generic/release/*-x86_64-signed.apk
        if-no-files-found: warn
        retention-days: 30

    - name: Upload x86 APK as Artifact
      if: steps.release_config.outputs.SHOULD_RELEASE == 'false'
      uses: actions/upload-artifact@v4
      with:
        name: SealPlus-${{ steps.version.outputs.VERSION }}-x86
        path: app/build/outputs/apk/generic/release/*-x86-signed.apk
        if-no-files-found: warn
        retention-days: 30

    - name: Upload Artifacts (Backup - Always)
      if: steps.release_config.outputs.SHOULD_RELEASE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: signed-apks-backup
        path: app/build/outputs/apk/generic/release/*-signed.apk
        if-no-files-found: error
        retention-days: 20
