stages:
  - build

variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"

build_job:
  stage: build
  image: mobiledevops/android-sdk-image:34.0.0-jdk17

  before_script:
    - |
      echo "Downloading Java 21..."
      curl -L https://download.oracle.com/java/21/latest/jdk-21_linux-x64_bin.tar.gz -o jdk21.tar.gz
      
      echo "Extracting Java..."
      tar -xzf jdk21.tar.gz
      
      # Find the folder name automatically
      JAVA_DIR=$(find . -maxdepth 1 -type d -name "jdk-21*" | head -n 1)
      export JAVA_HOME="$CI_PROJECT_DIR/$JAVA_DIR"
      export PATH="$JAVA_HOME/bin:$PATH"
      
      echo "Java Path is: $JAVA_HOME"
      java -version

      # FIX: Write the Java path to gradle.properties instead of the command line.
      # This prevents the "Task not found" error.
      echo "org.gradle.java.home=$JAVA_HOME" >> gradle.properties
      
      echo "Decoding Key..."
      echo "$ANDROID_SIGNING_KEY" | tr -d '\n' | tr -d ' ' | base64 -d > "$CI_PROJECT_DIR/Mahesh.jks"

  script:
    # --- STEP 1: EXTRACT VERSION ---
    - |
      VERSION=$(grep -A 1 'val currentVersion: Version =' buildSrc/src/main/kotlin/Version.kt | grep -oP 'versionMajor = \K\d+' | head -1).$(grep -A 1 'val currentVersion: Version =' buildSrc/src/main/kotlin/Version.kt | grep -oP 'versionMinor = \K\d+' | head -1).$(grep -A 1 'val currentVersion: Version =' buildSrc/src/main/kotlin/Version.kt | grep -oP 'versionPatch = \K\d+' | head -1)
      echo "ðŸš€ Building Version: $VERSION"

    # --- STEP 2: BUILD & SIGN ---
    # We moved the Java configuration to gradle.properties, so this command is clean now.
    # We put the signing variables on one line to ensure no spaces break it.
    - bash ./gradlew assembleRelease -Pandroid.injected.signing.store.file="$CI_PROJECT_DIR/Mahesh.jks" -Pandroid.injected.signing.store.password="$ANDROID_KEYSTORE_PASSWORD" -Pandroid.injected.signing.key.alias="$ANDROID_ALIAS" -Pandroid.injected.signing.key.password="$ANDROID_KEY_PASSWORD"

    # --- STEP 3: ORGANIZE OUTPUT ---
    - mkdir -p release_output
    - mv app/build/outputs/apk/generic/release/*-signed.apk release_output/ || true
    - mv app/build/outputs/apk/release/*.apk release_output/ || true

  artifacts:
    name: "SealPlus-$CI_COMMIT_SHORT_SHA"
    paths:
      - release_output/*.apk
    expire_in: 1 week
